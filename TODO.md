# TripSum 待办事项清单

## 📋 当前待办任务

### ✅ v1.7.0 已完成功能
- [x] **Excel导出功能实现** (2025-09-01)
  - ✅ 实现完整的5表格Excel导出（总览、支出、基金、成员财务、结算方案）
  - ✅ 添加后端exceljs服务，支持多工作表和格式化
  - ✅ 集成前端导出按钮到行程详情页面
  - ✅ 优化导出数据结构和中文本地化

- [x] **代码优化和清理** (2025-09-01) 
  - ✅ 清理无用的AI总结PDF导出相关代码
  - ✅ 移除TripStatistics页面和底部导航标签
  - ✅ 修复React hooks使用问题和consumptionDate显示
  - ✅ 优化AI解析逻辑，移除不必要的计算工具调用
  - ✅ 修复人均金额计算和中文日期显示问题

### 📊 统计功能优化 (优先级: 中)
- [x] **图表可视化组件** (已实现)
  - ✅ ExpensePieChart - 支出分类饼图
  - ✅ TrendLineChart - 时间趋势线图
  - ✅ MemberBarChart - 成员对比柱状图
  - ✅ StatCard - 统计指标卡片

### 🤖 AI行程复盘 (优先级: 中)
- [x] **智能分析功能** (已实现)
  - ✅ 大模型深度消费分析
  - ✅ 消费模式和习惯识别
  - ✅ 个性化消费建议生成
  
- [x] **总结报告生成** (已实现)
  - ✅ 自动行程总结报告生成
  - ✅ 消费亮点和问题点识别
  - ✅ 下次旅行优化建议
  - ✅ HTML格式报告导出

### 🏗️ userId架构优化 (优先级: 中)
- [ ] **基于userId_usage_report.md的优化**
  - 继续淡化userId在业务逻辑中的使用
  - 保留必要的认证相关userId
  - 优化服务层，统一使用memberId
  - 更新API文档，明确参数使用规范

### 📚 API文档重构 (优先级: 中)
- [ ] **拆分和重构API文档**
  - 将docs/API.md按功能模块拆分（认证、行程、支出、统计、AI）
  - 同步v1.5.0架构变更（memberId优先、管理员中心化结算）
  - 更新所有接口响应示例，反映最新数据结构
  - 添加基金池模式的详细说明和示例
  - 标记已废弃的接口和参数
  
- [ ] **数据访问层优化**
  - 创建统一的成员访问接口
  - 封装userId到memberId的转换逻辑
  - 减少直接的userId查询

### 🧪 E2E测试 (优先级: 中)
- [ ] **端到端测试套件**
  - 完整用户流程测试（注册→创建行程→记账→结算）
  - 多用户协作场景测试
  - 错误恢复测试
  
- [ ] **性能测试**
  - API响应时间测试
  - 并发用户压力测试
  - 大数据量场景测试

### 🎨 用户体验改进 (优先级: 中)
- [ ] **加载状态优化**
  - 展开支出详情时显示加载动画
  - 展开成员详情时显示加载动画
  - 统计数据加载时的骨架屏
  
- [ ] **错误处理完善**
  - 统计API失败时显示友好提示
  - 添加重试机制
  - 离线状态处理
  
- [ ] **交互优化**
  - 添加撤销/重做功能
  - 批量操作支持
  - 快捷键支持

### 🚀 性能优化 (优先级: 低)
- [ ] **Redis缓存层实现**
  - 为 `calculateBalances` 结果添加缓存
  - 为 `getTripStatistics` 结果添加缓存
  - 设置合理的缓存过期时间 (建议: 5分钟)
  
- [ ] **数据库查询优化**
  - 为 `expenses` 表的 `tripId` 和 `expenseDate` 添加复合索引
  - 为 `expense_participants` 表的 `tripMemberId` 添加索引
  - 优化 N+1 查询问题
  
- [ ] **分页和虚拟滚动**
  - 支出列表超过50条时启用虚拟滚动
  - 成员财务详情的分页加载
  - 优化大数据量的渲染性能

### 🔄 实时功能 (优先级: 低)
- [ ] **Socket.io 实时更新**
  - 支出创建/更新时广播参与者摘要
  - 余额变化时实时推送
  - 基金池状态变化通知
  - 在线成员状态显示

## 🐛 已知问题

### ✅ 已解决
- [x] **Excel导出功能开发** (2025-09-01)
  - 实现完整的后端Excel导出服务
  - 集成exceljs库，支持多工作表
  - 添加前端导出按钮和下载功能
  - 支持5个工作表：总览、支出明细、基金缴纳、成员财务、结算方案
  
- [x] **代码清理和优化** (2025-09-01)
  - 清理无用PDF导出功能代码
  - 移除TripStatistics冗余页面
  - 修复React hooks使用问题
  - 优化AI解析和日期显示问题
  
- [x] **TripDetail页面布局问题** (2025-09-01)
  - 修复CSS类名冲突（trip-summary → trip-info-card）
  - 解决Tabs不显示的问题
  - 优化flex布局传递
  
- [x] **操作按钮布局优化** (2025-09-01)
  - 从4列改为5列网格布局
  - 5个按钮在一行显示
  - 优化按钮样式和触摸反馈

### ⚠️ 待解决
- [ ] **大金额精度问题**
  - 集成Decimal.js库处理金额
  - 替换所有Number类型的金额计算
  - 添加金额格式化和验证
  
- [ ] **移动端样式优化**
  - 在真实设备上测试展开视图
  - 优化触摸交互体验
  - 适配不同屏幕尺寸

## 💡 未来功能建议

### 下一版本计划 (v1.8.0)
- 🔧 大金额精度问题修复 - Decimal.js集成
- 📚 API文档重构 - 按功能模块拆分
- 🏗️ userId架构优化 - 完全迁移到memberId
- 🧪 E2E测试套件完善

### 长期规划
- 🌍 多语言支持
- 📱 原生移动应用
- 🔗 第三方支付集成
- 📈 投资理财功能
- 🎯 目标储蓄计划

## 🔧 技术债务
1. **代码重构**
   - 抽取重复的参与者计算逻辑
   - 统一错误处理机制
   - 优化组件结构，减少嵌套
   
2. **文档完善**
   - 更新架构设计文档
   - 编写开发者指南
   - 添加部署文档

3. **测试覆盖**
   - 提高单元测试覆盖率到80%+
   - 添加更多集成测试场景
   - 实现自动化测试流程

## 📌 重要文件位置
- 后端支出服务: `/backend/src/services/expense.service.ts`
- 后端计算服务: `/backend/src/services/calculation.service.ts`
- 后端行程服务: `/backend/src/services/trip.service.ts`
- **后端导出服务**: `/backend/src/services/export.service.ts` ⭐
- 前端支出显示: `/frontend/src/pages/TripDetail.tsx`
- 前端行程Store: `/frontend/src/stores/trip.store.ts`
- **前端导出服务**: `/frontend/src/services/export.service.ts` ⭐
- **图表组件**: `/frontend/src/components/charts/` ⭐
- 类型定义: `/frontend/src/types/expense.types.ts`, `/frontend/src/types/trip.types.ts`

## 🏗️ 当前架构说明
- **数据获取流程**: TripDetail页面 → trip.store → 并行调用 getTripDetail + getStatistics API
- **统计API**: `/trips/:id/statistics` 返回完整的财务统计、成员状态、基金池信息
- **余额API**: `/trips/:id/balances` 独立的余额计算接口
- **结算模式**: 管理员中心化结算，所有交易通过管理员节点
- **标识体系**: memberId为主要业务标识，userId仅用于认证

---
*最后更新: 2025-09-01*  
*当前版本: v1.7.0*  
*主要更新: 新增Excel导出功能，代码优化清理*  
*下次工作重点: 大金额精度问题修复，API文档重构*