# 更新日志

所有关于TripSum项目的重要更改都记录在此文件中。

## [2.0.0] - 2025-09-11

### 🎉 重大更新：真实用户邀请系统

TripSum v2.0.0 是一个里程碑版本，将应用从单纯的记账工具升级为完整的多人协作平台。

#### ✨ 核心新功能

- **📨 邀请系统**
  - **两种邀请模式**：ADD模式（邀请新用户）、REPLACE模式（替换虚拟成员保留历史）
  - **智能邀请管理**：防重复邀请、7天自动过期、状态实时追踪
  - **完整流程控制**：发送→接受/拒绝→自动加入→数据迁移
  - 实时WebSocket通知

- **💌 消息中心**
  - **统一消息管理**：系统通知、邀请消息、费用变更一站式管理
  - **批量操作**：支持批量标记已读、归档、删除
  - **个性化设置**：消息偏好配置、通知频率控制
  - **实时推送**：WebSocket实时通知，无需刷新

- **🔐 权限管理**
  - **角色分离**：管理员vs普通成员，功能权限精确控制
  - **管理员专属**：发送邀请、添加/移除成员、AI记账功能、删除行程、批量更新基金缴纳
  - **UI权限控制**：基于角色动态显示/隐藏功能
  - 权限验证中间件架构

- **📡 消息队列架构**
  - **Bull + Redis**：高性能异步消息处理
  - **13个专门处理器**：针对不同消息类型的精细化处理
  - **可靠性保障**：消息持久化、错误重试、优雅关闭
  - 插件式消息处理器架构

#### 🛠️ 技术改进

- **前端优化**
  - **打包体积减少44%**：797KB → 446KB，首屏加载速度显著提升
  - **懒加载优化**：路由级代码分割，按需加载
  - **第三方库优化**：tree-shaking，减少50%的antd-mobile体积
  - **性能提升**：Recharts动态导入，manualChunks优化分包策略

- **后端架构**
  - **模块化重构**：28个服务模块，代码结构更清晰
  - **统一错误处理**：标准化API响应格式
  - **数据库优化**：新增4个表，支持完整的邀请和消息流程
  - **WebSocket增强**：连接管理、断线重连、房间管理

- **测试体系**
  - **测试覆盖**：60+集成测试用例，确保系统稳定性
  - **数据工厂**：标准化测试数据创建和清理
  - **Mock策略**：单元测试和集成测试分离
  - Jest和TypeScript集成，支持30秒超时

#### 🐛 Bug修复（共12个核心修复）

**消息系统修复**
- 修复message.store.ts的get未定义错误（Zustand store参数缺失）
- 修复Socket连接失败问题（URL配置错误）
- 修复消息列表重复调用和分页覆盖问题（React Hook依赖优化）
- 修复邀请消息按钮显示逻辑（后端状态检查）

**核心功能修复**
- 修复senderId为null导致的消息发送者丢失（notification服务传递inviterId）
- 修复浮点数精度验证错误（Decimal.js增加容差比较，解决200÷3精度问题）
- 改进AddMember页面，支持真实用户邀请（集成UserSearch和InvitationForm）
- 移除TripDetail页面未实现的编辑按钮，避免用户困惑

**代码质量**
- 修复前端TypeScript编译错误
- 清理debug console.log语句（TripList、trip.store、MessageCenter）
- 统一前后端MessageType枚举定义（17种详细类型）
- API参数命名标准化（keyword统一）

#### 🚀 数据库更新

**新增数据表**
```sql
- TripInvitation     # 邀请记录表（状态跟踪、过期机制）
- Message            # 消息记录表（统一通知管理）  
- MessageTemplate    # 消息模板表（标准化消息格式）
- MessagePreference  # 用户偏好表（个性化设置）
```

**新增枚举类型**
- InviteType: REPLACE、ADD
- InvitationStatus: PENDING、ACCEPTED、REJECTED、EXPIRED、CANCELLED
- MessageType: SYSTEM、INVITATION、EXPENSE、SETTLEMENT、REMINDER等17种
- MessageCategory、MessagePriority、MessageStatus等

#### 📋 API更新

- **新增19个接口**：
  - 消息系统：11个接口（列表、详情、偏好设置、批量操作等）
  - 邀请系统：8个接口（发送、接受、拒绝、查询等）
- **WebSocket事件**：新增6个实时事件（new_message、invitation_received等）
- **废弃接口**：原有直接添加成员接口，统一使用邀请流程
- 权限验证中间件：requireAdmin路由级权限控制

#### 🎯 架构改进亮点

**消息队列**：enterprise级的消息处理架构
- 消息工厂和调度器服务
- Redis缓存层优化（未读计数、最近消息列表）
- 5分钟窗口消息聚合，避免消息轰炸

**权限系统**：细粒度的功能权限控制
- 路由级权限控制使用requireAdmin中间件
- 前端UI权限控制作为UX优化
- 清晰的权限边界：管理员和普通成员功能明确分离

**性能优化**：44%的前端体积减少
- 主应用包：229KB → 32KB（减少86%）
- Antd-mobile：406KB → 204KB（减少50%）
- Recharts：415KB → 282KB（减少32%，且懒加载）

### 💡 团队协作价值

v2.0.0将TripSum从个人记账工具升级为真正的团队协作平台：

1. **无门槛邀请**：朋友无需预先注册即可被邀请
2. **数据继承**：虚拟成员数据无缝转换为真实用户  
3. **实时协作**：消息通知让团队保持同步
4. **权限保护**：管理员控制确保数据安全

### 🔄 迁移指南

#### 从v1.x升级到v2.0.0

1. **数据库迁移**
   ```bash
   cd backend
   npx prisma migrate dev
   ```

2. **依赖更新**
   ```bash
   # 后端新增Bull队列
   cd backend
   npm install bull @types/bull
   
   # 前端依赖更新
   cd frontend
   npm update
   ```

3. **代码适配**
   - 更新WebSocket事件监听器
   - 集成消息中心组件
   - 替换直接成员添加为邀请流程

4. **权限调整**
   - 检查管理员专属功能权限
   - 更新UI显示逻辑（基于角色）

#### ⚠️ 已知问题

1. **测试问题**：部分集成测试需要调整（不影响功能）
2. **ESLint配置**：前后端缺少ESLint配置文件（已知问题）
3. **兼容性**：建议Chrome 90+或同等现代浏览器

## [1.10.0] - 2025-09-04
### 🏗️ userId架构优化
#### 架构改进
- **AI控制器修复**: 修正parseUserInput中userId到memberId的错误转换
- **统一数据访问层**: 创建member.service.ts提供统一的成员访问接口
- **明确使用原则**: 
  - 认证层使用userId（JWT、登录、权限验证）
  - 业务层使用memberId（费用、成员管理、结算、AI解析）

#### 新增功能
- 创建MemberService类，提供以下核心方法：
  - `getMemberIdByUserId()`: userId到memberId转换
  - `checkAndGetMember()`: 验证并获取成员信息
  - `getUserIdToMemberIdMap()`: 批量转换映射
  - `isValidMember()`: 成员有效性检查

#### 文档更新
- API_OVERVIEW.md增加详细的标识体系使用指南
- 明确API参数规范（路径参数、请求体、认证头）
- 添加数据转换最佳实践

#### 代码优化
- AI控制器正确获取当前用户的memberId
- 保持向后兼容，原有基于userId的方法仍可用
- TypeScript类型检查全部通过

## [1.9.0] - 2025-09-04
### 📚 API文档重构
#### 文档改进
- **模块化拆分**: 将单一的API.md拆分为6个独立文档
  - API_OVERVIEW.md - 总览和通用规范
  - API_AUTH.md - 认证相关接口
  - API_TRIP.md - 行程管理接口
  - API_EXPENSE.md - 支出管理接口  
  - API_STATISTICS.md - 统计与结算接口
  - API_AI.md - AI功能接口
- **内容更新**: 同步v1.5.0架构变更（memberId优先、管理员中心化结算）
- **示例完善**: 为每个接口添加详细的请求/响应示例
- **使用场景**: 增加实际使用场景和最佳实践说明
- **错误处理**: 完善错误码说明和处理建议
- **代码示例**: 添加JavaScript/TypeScript调用示例

#### 架构说明
- 强调memberId作为主要业务标识
- 详细说明基金池模式运作机制
- 补充Decimal.js精度处理说明
- 更新WebSocket事件文档

## [1.8.0] - 2025-09-04
### 🎯 金额精度优化
#### 新增功能
- **Decimal.js集成**: 彻底解决JavaScript浮点数精度问题
- **统一金额处理**: 前后端统一使用Decimal.js进行金额计算
- **精确到分**: 所有金额计算精确到小数点后两位

#### 后端改进
- 创建统一的AmountUtil工具类 (`/backend/src/utils/decimal.ts`)
- 重构4个核心服务文件，移除29处toNumber()调用
- 添加完整的单元测试（39个测试用例）
- 添加集成测试覆盖7个业务场景

#### 前端改进  
- 创建前端AmountUtil工具类 (`/frontend/src/utils/decimal.ts`)
- 替换6处parseFloat()调用为精确计算
- 添加单元测试（26个测试用例）
- 统一用户输入金额的解析逻辑

#### 修复问题
- ✅ 0.1 + 0.2 现在正确等于 0.30
- ✅ AA制分账精确处理（1000元3人分 = 333.33, 333.33, 333.34）
- ✅ 百分比分摊精确到分，无累计误差
- ✅ 大金额（9,999,999.99）计算无精度损失
- ✅ 基金池余额计算精度问题

## [1.7.0] - 2025-09-01
### 📊 Excel导出功能
#### 新增功能
- **完整Excel导出**: 支持5个工作表（总览、支出、基金、成员财务、结算方案）
- **后端导出服务**: 集成exceljs库，支持多工作表和格式化
- **前端集成**: 在行程详情页面添加导出按钮
- **数据本地化**: 优化中文显示和日期格式

## [1.6.0] - 2025-09-01
### 🔧 代码优化和清理
#### 优化改进
- 清理无用的AI总结PDF导出相关代码
- 移除TripStatistics冗余页面和底部导航标签
- 修复React hooks使用问题
- 优化AI解析逻辑，移除不必要的计算工具调用
- 修复人均金额计算和中文日期显示问题
- 修复consumptionDate显示问题

## [1.5.2] - 2025-09-02
### 🐛 修复部署问题
#### 修复
- 解决首次部署数据库迁移P3005错误
- 智能启动脚本自动检测并处理首次部署/更新部署场景
- 修复manage.sh中DOCKER_COMPOSE_CMD变量作用域问题
#### 新增
- 新增部署命令：`init`首次部署，`clean`清理数据
- 优化初始化流程：分离数据库结构创建和数据初始化

## [1.5.1] - 2025-09-01
### 📦 架构简化
#### 优化改进
- 从9个配置文件简化为2个核心文件
- 开发环境完全本地化，无需Docker依赖
- 一键生产部署：自动Git同步，智能环境检查
- 优化CORS和Nginx配置，支持IP直接访问
- 删除MinIO和多余部署文档，专注核心功能

## [1.5.0] - 2025-08-29
### 🏗️ 架构重构
#### 重大改进
- **架构迁移**: 完成userId到memberId架构迁移，统一标识体系
- **结算优化**: 管理员中心化结算，所有结算通过管理员节点
- **性能提升**: getUserTrips减少90%+数据传输量
- **测试体系**: 搭建Jest(后端)+Vitest(前端)完整测试框架
#### 修复
- 修复虚拟成员显示问题
- 修复余额计算精度问题
- 修复成员确认对话框关闭问题
#### 文档
- 更新API文档反映新架构
- 添加技术架构说明文档

## [1.4.0] - 2025-08-28
### 🔄 API架构重构
#### 优化改进
- **API整合**: 统一统计API，优化数据结构
- **统计增强**: 新增成员财务详情，完善基金池状态追踪
- **计算升级**: 重构余额计算逻辑，支持复杂场景
- **服务优化**: 统一前后端数据结构，提升维护性
- **API精简**: 从28个接口优化至20个
#### 修复
- 修复基金贡献解析（正数金额）
- 统一虚拟和真实成员处理逻辑
- 支持累计基金缴纳

## [1.3.0] - 2025-08-27
### 💰 双模式支付系统
#### 新增功能
- **基金池支付**: 创新的基金池+垫付混合管理模式
- **AI计算器**: Function Calling集成，确保计算精确
- **多行程支持**: 记账页面支持行程切换
- **智能统计**: 区分基金池与个人垫付统计

## [1.2.0] - 2025-08-27
### 🎨 界面优化
#### 新增功能
- **UI重构**: TripDetail页面操作按钮网格化布局
- **AI架构**: 模块化意图优先解析系统
- **虚拟成员**: 支持未注册用户参与计算
- **权限管理**: 基于角色的功能控制

## [1.1.0] - 2024-08
### 🤖 AI智能化
#### 新增功能
- AI智能记账：自然语言解析
- 成员看板：可视化成员财务状态
- 实时通信：WebSocket多人协作

## [1.0.0] - 2024-08
### 🎉 初始版本
#### 核心功能
- 基础记账功能
- 费用分摊计算
- 结算方案生成
- 移动端适配

---

格式说明：
- 🎯 主要功能
- 🎨 界面/UX
- 🤖 AI相关
- 🏗️ 架构改进
- 🔧 优化/重构
- 🐛 Bug修复
- 📦 部署/配置
- 📊 数据/统计
- 💰 财务功能
- 🔄 同步/实时
- 📚 文档
- 🧪 测试
- ✅ 已解决