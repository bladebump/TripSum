# TripSum 开发历程

## 项目概述
TripSum（旅算）是一款专为小团体旅行设计的费用分摊应用，通过智能算法实现零和结算，让朋友间的费用分摊变得简单透明。

## 版本历史

### 🎯 v1.10.0 - userId架构优化 (2025-09-04)
**里程碑**: 完成架构优化，明确认证与业务层分离

#### 主要成就
- ✅ 修复AI控制器中userId到memberId的错误转换
- ✅ 创建member.service.ts统一数据访问层（9个核心方法）
- ✅ 新增65个测试用例，实现100%通过率
- ✅ TypeScript编译零错误

#### 技术决策
- 认证层使用userId（JWT、登录、权限验证）
- 业务层使用memberId（费用、成员、结算、AI）
- 保持向后兼容，原有功能不受影响

---

### 📚 v1.9.0 - API文档模块化 (2025-09-04)
**里程碑**: API文档重构，提升可维护性

#### 主要成就
- ✅ 将单一API.md拆分为6个独立文档
- ✅ 同步v1.5.0架构变更
- ✅ 添加详细的请求/响应示例

#### 文档结构
- API_OVERVIEW.md - 总览和通用规范
- API_AUTH.md - 认证相关接口
- API_TRIP.md - 行程管理接口
- API_EXPENSE.md - 支出管理接口
- API_STATISTICS.md - 统计与结算接口
- API_AI.md - AI功能接口

---

### 🎯 v1.8.0 - 金额精度优化 (2025-09-04)
**里程碑**: 彻底解决JavaScript浮点数精度问题

#### 主要成就
- ✅ 前后端统一集成Decimal.js
- ✅ 创建AmountUtil工具类
- ✅ 39个金额计算测试用例全部通过
- ✅ 解决0.1 + 0.2 ≠ 0.3的经典问题

#### 技术细节
- 后端：重构4个核心服务，移除29处toNumber()调用
- 前端：替换6处parseFloat()为精确计算
- 精度：所有金额精确到小数点后两位

---

### 💰 v1.5.0 - memberId架构与管理员结算 (2025-08-29)
**里程碑**: 架构优化，实现管理员中心化结算

#### 主要成就
- ✅ memberId成为主要业务标识
- ✅ 实现管理员中心化结算模式
- ✅ 优化债务关系算法

---

### 🏦 v1.4.0 - 基金池模式 (2025-08-20)
**里程碑**: 引入基金预收管理模式

#### 主要成就
- ✅ 添加contribution字段记录基金缴纳
- ✅ 智能识别付款方（管理员=基金池，其他=需报销）
- ✅ 余额公式：balance = contribution + reimbursements - shares
- ✅ 虚拟成员完全统一化

#### 创新点
- 双重支付模式：基金池支付 & 成员垫付报销
- 累计式基金缴纳，避免覆盖
- 实时基金池状态追踪

---

### 🤖 v1.3.0 - AI计算器集成 (2025-08-15)
**里程碑**: Function Calling支持，精确数学计算

#### 主要成就
- ✅ 实现calculator工具
- ✅ OpenAI Function Calling集成
- ✅ 避免LLM算术错误

---

### 🧠 v1.2.0 - 模块化AI架构 (2025-08-10)
**里程碑**: 意图识别系统上线

#### 主要成就
- ✅ 意图分类：expense/member/mixed/settlement/unknown
- ✅ 专门解析器：费用解析、成员解析、混合意图处理
- ✅ 统一协调器：ai.unified.parser

---

### 👥 v1.1.0 - 虚拟成员支持 (2025-08-05)
**里程碑**: 支持非注册用户参与

#### 主要成就
- ✅ 虚拟成员创建（displayName识别）
- ✅ 参与所有计算和结算
- ✅ 与真实用户功能对等

---

### 🚀 v1.0.0 - 正式版本发布 (2025-08-01)
**里程碑**: MVP完成，核心功能就绪

#### 核心功能
- ✅ 用户注册登录（JWT认证）
- ✅ 行程创建管理
- ✅ 支出记录分摊
- ✅ 智能余额计算
- ✅ 零和结算算法
- ✅ 基础AI解析

## 技术栈演进

### 前端技术栈
- **框架**: React 18 + TypeScript 5
- **UI组件**: Ant Design Mobile 5
- **状态管理**: Zustand
- **构建工具**: Vite
- **图表**: Recharts

### 后端技术栈
- **运行时**: Node.js 20
- **框架**: Express + TypeScript
- **ORM**: Prisma
- **数据库**: PostgreSQL 15
- **缓存**: Redis 7
- **实时通信**: Socket.io
- **AI**: OpenAI GPT-4 / Claude API

## 重要技术决策记录

### 2025-09-04: userId vs memberId架构
- **问题**: userId在业务逻辑中被误用
- **决策**: 严格区分认证层(userId)和业务层(memberId)
- **影响**: 提升代码清晰度，减少bug

### 2025-08-20: 基金池模式
- **问题**: 预收款管理复杂
- **决策**: 引入contribution字段和智能付款识别
- **影响**: 简化财务管理流程

### 2025-08-10: AI架构重构
- **问题**: 单一AI解析器难以扩展
- **决策**: 采用意图识别+专门解析器架构
- **影响**: 提升AI准确率和可维护性

## 团队贡献者
- 核心开发：TripSum团队
- AI辅助：Claude Code

## 项目统计
- **代码行数**: 20,000+
- **测试用例**: 100+
- **API接口**: 20+
- **数据库表**: 8个
- **支持语言**: 中文（计划支持多语言）

## 未来规划
- 🚀 性能优化：Redis缓存层
- 🔄 实时功能：Socket.io增强
- 📱 移动应用：原生APP开发
- 🌍 国际化：多语言支持
- 🔗 第三方集成：支付平台对接

---
*持续更新中...*
*最后更新: 2025-09-04*